# 1. An official Node.js runtime as a parent image
FROM node:22.15-alpine3.21

# 2. Set the working directory
WORKDIR /app

# 3. Copy package files first
COPY package*.json ./

# 4. Install dependencies
RUN npm install

# 5. Generate Prisma client (must happen before build)
RUN npx prisma generate

# 6. Copy the rest of the application code
COPY . .

# 7. Build the application
RUN npm run build

# 8. Copy and prepare the entrypoint script
COPY shell.sh /app/shell.sh
RUN chmod +x /app/shell.sh

# 9. Remove the DATABASE_URL from here (set at runtime)
# 10. Expose the port
EXPOSE 3000

# 11. Use the shell script as entrypoint
ENTRYPOINT ["./shell.sh"]